{
  "branchName": "ralph/riot-merch-self-heal",
  "projectName": "riot-merch-bot",
  "objective": "Make the Riot Merch purchasing bot fully autonomous and self-healing for the target item, using account rotation and non-URL navigation.",
  "constraints": [
    "Never hardcode product URLs; navigate via visible text, search, and page discovery.",
    "Accept cookies early so cart and checkout buttons appear.",
    "Must be signed in before add-to-cart; must sign out after checkout (or after final confirmation step).",
    "One item per account; rotate multiple Riot accounts in a single run from .env.",
    "Skip any blank .env fields and never overwrite site defaults.",
    "Avoid brittle deep DOM selectors; use multi-fallback strategies.",
    "Auto-retry with backoff; capture screenshot and logs on every failure.",
    "Never block waiting for user input.",
    "Prefer CDP connect-to-existing-browser mode for Riot-authenticated sessions."
  ],
  "envSpec": {
    "accounts": "RIOT_USER_1/RIOT_PASS_1 ... RIOT_USER_N/RIOT_PASS_N (skip blanks).",
    "targetProduct": "PRODUCT1 (supports synonyms separated by |) and QTY1.",
    "connectExisting": "CONNECT_EXISTING=1 and CDP_ENDPOINT=http://127.0.0.1:9222",
    "safetyModes": "DRY_RUN, CHECKOUT_ENABLED, FULL_SEND, KEEP_OPEN must be respected."
  },
  "qualityChecks": [
    "npm test",
    "npm run lint",
    "npm start -- --dry-run"
  ],
  "userStories": [
    {
      "id": "S1",
      "priority": 1,
      "title": "Fix CDP connection reliability (avoid ECONNREFUSED and IPv6 loopback issues)",
      "passes": false,
      "acceptanceCriteria": [
        "Bot connects when Chrome is started with --remote-debugging-port and a dedicated user-data-dir.",
        "CDP endpoint defaults to 127.0.0.1 (never ::1 or localhost).",
        "Bot verifies the CDP endpoint via /json/version before connecting.",
        "Connection failures produce actionable logs and screenshots if a page exists."
      ]
    },
    {
      "id": "S2",
      "priority": 2,
      "title": "Cookie consent must be accepted early so cart/checkout buttons appear",
      "passes": false,
      "acceptanceCriteria": [
        "Cookie banner is handled on first navigation.",
        "Cookie acceptance is idempotent.",
        "Failure includes selector attempts and a screenshot."
      ]
    },
    {
      "id": "S3",
      "priority": 3,
      "title": "Robust signed-in detection and account state management",
      "passes": false,
      "acceptanceCriteria": [
        "When CONNECT_EXISTING=1, bot verifies signed-in state.",
        "If not signed in, bot logs clear failure and stops safely.",
        "Bot never attempts automated Riot credential entry unless explicitly enabled."
      ]
    },
    {
      "id": "S4",
      "priority": 4,
      "title": "Product discovery without URLs using fuzzy title match",
      "passes": false,
      "acceptanceCriteria": [
        "Bot finds product by matching PRODUCT1 against visible titles.",
        "Supports pagination, infinite scroll, and lazy loading.",
        "Logs top match candidates when failing."
      ]
    },
    {
      "id": "S5",
      "priority": 5,
      "title": "Add-to-cart with resilient button detection and quantity enforcement",
      "passes": false,
      "acceptanceCriteria": [
        "Multiple fallback strategies locate Add to Cart / Buy / Preorder.",
        "QTY1 is enforced and one-per-account limits detected.",
        "Limit or OOS moves to next account."
      ]
    },
    {
      "id": "S6",
      "priority": 6,
      "title": "Checkout flow respects DISCOUNT_CODE and skips blank env fields",
      "passes": false,
      "acceptanceCriteria": [
        "Blank DISCOUNT_CODE is ignored.",
        "Blank env fields do not overwrite existing site values.",
        "Checkout reaches confirmation step in safe mode."
      ]
    },
    {
      "id": "S7",
      "priority": 7,
      "title": "Multi-account rotation in a single execution",
      "passes": false,
      "acceptanceCriteria": [
        "Iterates RIOT_USER_1/PASS_1 ... RIOT_USER_N/PASS_N skipping blanks.",
        "For each account: verify login → attempt purchase → sign out → continue.",
        "Browser resets cleanly if unhealthy."
      ]
    },
    {
      "id": "S8",
      "priority": 8,
      "title": "Unified failure artifacts: screenshots + logs with account and step name",
      "passes": false,
      "acceptanceCriteria": [
        "All failures include account index, step name, URL, and error.",
        "Screenshot filenames include account and step.",
        "Logs are timestamped per run."
      ]
    }
  ]
}
