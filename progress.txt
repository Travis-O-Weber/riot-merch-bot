## Codebase Patterns
- CDP connection uses 127.0.0.1 instead of localhost to avoid IPv6 ::1 resolution
- Browser functions are in `src/brave.js`, use `connectToExistingChrome()` for CDP mode
- Retry logic uses exponential backoff with delays: [500, 1000, 2000, 4000, 8000]ms
- Utility functions (log, sleep, captureScreenshot) are in `src/util.js`
- Configuration values are in `src/config.js`, env parsing in `src/env.js`
- Cookie consent handling is in NavigationManager.handleCookieConsent() - idempotent (tracks `_cookieConsentHandled`)
- Sign-in detection uses AccountManager.isSignedInDetailed() with 5 strategies; verifySignedInOrFail() for safe error handling
- Product discovery uses fuzzyMatch() from util.js; on failure, _logTopCandidates() logs top 5 matches with scores
- Add-to-cart uses structured results: `{success, status: 'success'|'limit_reached'|'out_of_stock'|'error', message}`
- Preorder buttons supported via selectors: preorder(), preorderFallback1-3()
- Purchase limit detection via _checkForPurchaseLimit() with regex patterns for various limit messages

---

## 2026-01-12T23:45:00Z - S1
Thread: https://ampcode.com/threads/T-019bb497-cd88-76b7-bc07-91e56dbeee13
- Implemented reliable CDP connect mode with IPv6 fix
- Added verifyCdpEndpoint() to check /json/version before connecting
- Added exponential backoff retry respecting MAX_RETRIES config
- Added logChromeInstructions() with actionable steps for launching Chrome
- Changed default CDP_ENDPOINT from localhost to 127.0.0.1
- Files changed:
  - src/brave.js (major refactor of connectToExistingChrome)
  - src/config.js (default CDP_ENDPOINT updated)
  - .env.example (added CONNECT_EXISTING and CDP_ENDPOINT docs)
- **Learnings for future iterations:**
  - Always use 127.0.0.1 instead of localhost to avoid IPv6 resolution
  - The http module is already available in Node.js for simple HTTP checks
  - Chrome requires --user-data-dir flag alongside --remote-debugging-port
  - ESLint is not configured in this project (v9 requires eslint.config.js)
---

## 2026-01-14T04:52:00Z - S2
Thread: https://ampcode.com/threads/T-019bbad6-6c5c-76b7-8b03-e9daa1e0f723
- Added WebSocket debugger URL fallback for CDP connection
- Modified verifyCdpEndpoint() to extract webSocketDebuggerUrl from /json/version response
- Added tryConnectCDP() helper to try connection with a specific method (HTTP or WebSocket)
- Refactored connectToExistingChrome() to try HTTP first, then fall back to WebSocket
- Added clear logging indicating which CDP method (HTTP or WebSocket) was used
- Added captureConnectionFailure() utility for failure screenshots with step context
- Files changed:
  - src/brave.js (added WebSocket fallback, tryConnectCDP, captureConnectionFailure)
- **Learnings for future iterations:**
  - Chrome's /json/version endpoint returns webSocketDebuggerUrl which can be used as fallback
  - Playwright's connectOverCDP() works with both HTTP endpoints and WebSocket URLs
  - Always include step name in failure logs and screenshots for debugging
---

## 2026-01-14T04:55:00Z - S3
Thread: https://ampcode.com/threads/T-019bbad9-fe78-75ac-ab5a-0df5bf7c3610
- Made cookie consent handling idempotent using `_cookieConsentHandled` flag
- Added 36 accept selectors with named identifiers (OneTrust, CookieBot, common patterns)
- Added 9 decline selectors as fallback
- Added banner detection to warn when popup is visible but no button found
- Returns structured result with `{handled, method, selectorsAttempted}`
- Added `force` option to re-check even if already handled
- Added `resetCookieConsentState()` for page navigation scenarios
- Takes screenshot on failure with selector attempts logged
- Files changed:
  - src/classes/NavigationManager.js (handleCookieConsent refactor)
- **Learnings for future iterations:**
  - Use named selectors (object with `selector` and `name`) for better logging
  - Track state with instance flags like `_cookieConsentHandled` for idempotency
  - Return structured results to allow callers to inspect what happened
---

## 2026-01-14T05:00:00Z - S4
Thread: https://ampcode.com/threads/T-019bbadc-e1ec-757f-b086-50b4d059683c
- Implemented signed-in state detection in CONNECT_EXISTING mode
- Added `isSignedInDetailed()` with 5 detection strategies and structured results
- Added `verifySignedInOrFail()` for safe error handling with screenshots
- Removed `_waitForManualSignIn()` - bot never requests manual input
- Bot stops safely with clear error message if not signed in
- Files changed:
  - src/classes/AccountManager.js (isSignedInDetailed, verifySignedInOrFail)
  - src/classes/RiotMerchBot.js (removed _waitForManualSignIn, uses verifySignedInOrFail)
- **Learnings for future iterations:**
  - Return detailed/structured results from detection functions for better debugging
  - CONNECT_EXISTING mode should never wait for manual input - stop safely instead
  - Provide actionable instructions in error messages (e.g., step-by-step how to sign in)
  - Multiple detection strategies needed: URL check, sign-in button, sign-out button, account links
---

## 2026-01-14T05:05:00Z - S5
Thread: https://ampcode.com/threads/T-019bbae0-ebb9-7756-b41e-410f63d67675
- Implemented product discovery with top 5 candidate logging on failure
- Added `_calculateBestMatchScore()` to compute similarity scores for all products
- Added `_logTopCandidates()` to log top 5 matches with scores and take screenshot
- Modified `_findProductInListing()` to collect candidates and call logging on failure
- Added screenshot capture for all failure scenarios (no cards, no titles, failed search)
- Files changed:
  - src/classes/ProductHandler.js (added scoring and logging functions)
- **Learnings for future iterations:**
  - Existing fuzzyMatch() and _loadAllProducts() already satisfied most S5 acceptance criteria
  - Key gap was logging candidates on failure - always log what was found vs. what was searched
  - Use stringSimilarity.compareTwoStrings() directly when calculating numeric scores
  - Screenshots on failure are essential for debugging product discovery issues
---

## 2026-01-14T05:10:00Z - S6
Thread: https://ampcode.com/threads/T-019bbae4-d348-71d0-b997-b2423e6469eb
- Implemented resilient add-to-cart with multiple fallback button strategies
- Added Preorder button selectors (preorder, preorderFallback1-3) to selectors.js
- Refactored _clickAddToCart() to support Add to Cart, Buy Now, and Preorder buttons
- Added _checkForPurchaseLimit() with regex patterns to detect 1-per-account limits
- Added _verifyItemAdded() to confirm successful cart addition via drawer/notification
- Added purchase limit selectors (purchaseLimitFallback3-4, quantityLimitMessage, etc.)
- Added success confirmation selectors (addedToCartConfirmation, etc.)
- Updated processAllProducts() to return structured results with status per product
- Updated RiotMerchBot._runProductFlow() to log individual product results
- Files changed:
  - src/selectors.js (added preorder and limit detection selectors)
  - src/classes/ProductHandler.js (structured results, limit detection, preorder support)
  - src/classes/RiotMerchBot.js (handle structured product results)
- **Learnings for future iterations:**
  - Use structured return values for add-to-cart: {success, status, message}
  - Don't retry on limit_reached or out_of_stock - only retry on transient errors
  - Regex patterns for limit detection: /limit(ed)?\s*(to|of|reached|per)/i, etc.
  - Preorder buttons common for upcoming releases - must be in fallback chain
---

## 2026-01-14T05:13:00Z - S7
Thread: https://ampcode.com/threads/T-019bbaea-19e5-73e6-99e0-f1f677784dae
- Verified checkout flow respects DISCOUNT_CODE and safe-stop rules
- All acceptance criteria already implemented by existing code:
  - Blank DISCOUNT_CODE handling in FormFiller.applyDiscountCode() (lines 191-194)
  - Blank env fields skip filling AND don't overwrite existing values via _fillField() (lines 261-264, 273-277)
  - FULL_SEND=0 safe stop with screenshot in _reviewAndPlaceOrder()
- Updated safe-stop log message to include "SAFE_STOP_BEFORE_PURCHASE" per acceptance criteria
- Changed screenshot name from 'final-review-stopped' to 'safe-stop-final-review'
- Files changed:
  - src/classes/CheckoutManager.js (updated log messages for SAFE_STOP_BEFORE_PURCHASE)
- **Learnings for future iterations:**
  - FormFiller._fillField() already checks for existing values before filling - safe by default
  - FormFiller._fillSelect() also skips when value is blank
  - When reviewing acceptance criteria, check if existing code already satisfies requirements before implementing
  - Use explicit constant names like SAFE_STOP_BEFORE_PURCHASE in logs for easy grep-ability
---
